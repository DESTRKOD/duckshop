<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
<style>
/* ===== –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò (–¢–û–ß–ù–û –ö–ê–ö –í –û–°–ù–û–í–ù–û–ú –§–ê–ô–õ–ï) ===== */
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(180deg, #0b3c91 0%, #1565c0 55%, #42a5f5 100%);
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ===== –≠–ö–†–ê–ù –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ===== */
.auth-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
  box-sizing: border-box;
  width: 100%;
  max-width: 320px;
}

/* ===== LOTTIE –ê–ù–ò–ú–ê–¶–ò–Ø ===== */
.sticker {
  width: 200px;
  height: 200px;
  margin-bottom: 20px;
}

@media (max-width: 480px) {
  .sticker {
    width: 160px;
    height: 160px;
  }
}

/* ===== –ó–ê–ì–û–õ–û–í–û–ö ===== */
.title {
  margin: 0 0 25px 0;
  font-size: 24px;
  font-weight: 800;
  color: #fff;
  text-align: center;
}

@media (max-width: 480px) {
  .title {
    font-size: 22px;
    margin-bottom: 20px;
  }
}

/* ===== –ö–ù–û–ü–ö–ò –¢–û–ß–ù–û –ö–ê–ö "–ü–†–û–î–û–õ–ñ–ò–¢–¨" –í –û–°–ù–û–í–ù–û–ú –§–ê–ô–õ–ï ===== */
.button {
  width: 100%;
  max-width: 280px;
  margin: 8px 0; /* –£–º–µ–Ω—å—à–∏–ª –æ—Ç—Å—Ç—É–ø—ã –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ */
  padding: 18px 0;
  font-size: 18px;
  font-weight: 800;
  background: #fff;
  color: #0b3c91;
  border-radius: 18px;
  border: none;
  box-shadow: 0 16px 36px rgba(0,0,0,.45);
  cursor: pointer;
  user-select: none;
  transition: transform .12s ease, box-shadow .12s ease;
  outline: none;
}

/* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è (–¢–û–ß–ù–û –ö–ê–ö –í –û–°–ù–û–í–ù–û–ú –§–ê–ô–õ–ï) */
.button:active {
  transform: translateY(6px) scale(.9);
  box-shadow: 0 6px 14px rgba(0,0,0,.35);
}

.button:disabled {
  background: #cccccc;
  color: #666666;
  cursor: not-allowed;
  transform: none !important;
  box-shadow: 0 8px 20px rgba(0,0,0,.25) !important;
}

/* ===== –¢–ï–ö–°–¢ –ü–û–î –ö–ù–û–ü–ö–ê–ú–ò ===== */
.telegram-note {
  margin-top: 15px;
  color: rgba(255,255,255,0.8);
  font-size: 14px;
  text-align: center;
  max-width: 280px;
  line-height: 1.4;
}

@media (max-width: 480px) {
  .telegram-note {
    font-size: 13px;
  }
}

/* ===== –°–¢–ê–¢–£–°–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø ===== */
.status-message {
  margin-top: 15px;
  padding: 12px 16px;
  border-radius: 14px;
  font-size: 14px;
  font-weight: 700;
  text-align: center;
  display: none;
  width: 100%;
  max-width: 280px;
  box-sizing: border-box;
}

.status-loading {
  background: rgba(255,255,255,0.1);
  color: white;
  border-left: 4px solid #4fc3f7;
}

.status-success {
  background: rgba(0,200,83,0.15);
  color: white;
  border-left: 4px solid #00c853;
}

.status-error {
  background: rgba(255,45,85,0.15);
  color: white;
  border-left: 4px solid #ff2d55;
}

/* ===== –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ ===== */
@media (max-width: 360px) {
  .auth-screen {
    padding: 15px;
  }
  
  .title {
    font-size: 20px;
    margin-bottom: 15px;
  }
  
  .button {
    padding: 16px 0;
    font-size: 16px;
    max-width: 260px;
    margin: 6px 0; /* –ï—â–µ –º–µ–Ω—å—à–µ –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
  }
  
  .telegram-note {
    font-size: 12px;
    max-width: 260px;
  }
}
</style>
</head>

<body>
<div class="auth-screen">
  <!-- Lottie –∞–Ω–∏–º–∞—Ü–∏—è -->
  <div id="lottie-animation" class="sticker"></div>
  
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <div class="title">–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ –º–∞–≥–∞–∑–∏–Ω–µ</div>
  
  <!-- –ö–Ω–æ–ø–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
  <button class="button" id="registerBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
  
  <!-- –ö–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞ -->
  <button class="button" id="loginBtn">–í–æ–π—Ç–∏</button>
  
  <!-- –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ -->
  <button class="button" id="backBtn">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω</button>
  
  <!-- –¢–µ–∫—Å—Ç –ø—Ä–æ Telegram -->
  <div class="telegram-note">* –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è Telegram</div>
  
  <!-- –°—Ç–∞—Ç—É—Å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è -->
  <div class="status-message status-loading" id="loadingMessage">
    ‚è≥ –û—Ç–∫—Ä—ã–≤–∞–µ–º Telegram...
  </div>
  
  <div class="status-message status-success" id="successMessage">
    ‚è≥ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ Telegram –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...
  </div>
  
  <div class="status-message status-error" id="errorMessage"></div>
</div>

<script>
const API_URL = 'https://duck-shop-sever.onrender.com';
const SITE_URL = 'https://DESTRKOD.github.io/duck2';
const USER_KEY = 'duck_user_v1'; 

// –≠–ª–µ–º–µ–Ω—Ç—ã
const registerBtn = document.getElementById('registerBtn');
const loginBtn = document.getElementById('loginBtn');
const backBtn = document.getElementById('backBtn');
const loadingMessage = document.getElementById('loadingMessage');
const successMessage = document.getElementById('successMessage');
const errorMessage = document.getElementById('errorMessage');

let currentToken = null;
let checkInterval = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Lottie –∞–Ω–∏–º–∞—Ü–∏–∏
function initLottieAnimation() {
  try {
    lottie.loadAnimation({
      container: document.getElementById('lottie-animation'),
      renderer: 'svg',
      loop: true,
      autoplay: true,
      path: 'reg_log.json'
    });
  } catch (e) {
    console.log('Lottie –∞–Ω–∏–º–∞—Ü–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    document.getElementById('lottie-animation').innerHTML = 'üîê';
  }
}

// –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç—É—Å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
function showStatus(type, message = '') {
  loadingMessage.style.display = 'none';
  successMessage.style.display = 'none';
  errorMessage.style.display = 'none';
  
  switch(type) {
    case 'loading':
      loadingMessage.style.display = 'block';
      break;
    case 'success':
      successMessage.style.display = 'block';
      break;
    case 'error':
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      break;
  }
}

// –û—á–∏—Å—Ç–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏
function clearCheckInterval() {
  if (checkInterval) {
    clearInterval(checkInterval);
    checkInterval = null;
  }
}

// –ù–∞–∑–∞–¥ –≤ –º–∞–≥–∞–∑–∏–Ω
backBtn.addEventListener('click', () => {
  window.location.href = `${SITE_URL}/main.html`;
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è Telegram
function openTelegram(link) {
  // –ü—Ä–æ–±—É–µ–º –æ—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ/–≤–∫–ª–∞–¥–∫–µ
  const newWindow = window.open(link, '_blank');
  
  // –ï—Å–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫ –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö –æ–∫–æ–Ω –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
  if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
    showStatus('error', '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å Telegram. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –≤—Ä—É—á–Ω—É—é.');
    
    // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è
    const manualLink = document.createElement('a');
    manualLink.href = link;
    manualLink.target = '_blank';
    manualLink.textContent = '–ù–∞–∂–º–∏—Ç–µ –∑–¥–µ—Å—å —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å Telegram';
    manualLink.style.color = 'white';
    manualLink.style.textDecoration = 'underline';
    manualLink.style.marginTop = '10px';
    manualLink.style.display = 'block';
    
    errorMessage.appendChild(manualLink);
  }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
async function checkAuthStatus(token, button) {
  try {
    const response = await fetch(`${API_URL}/api/auth/check/${token}`);
    const data = await response.json();
    
    if (data.success && data.authenticated) {
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
      clearCheckInterval();
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –û–î–ò–ù–ê–ö–û–í–´–ú –∫–ª—é—á–æ–º
      localStorage.setItem(USER_KEY, JSON.stringify(data.user));
      console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', data.user.username);
      
      // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ–±—Ä–∞—Ç–Ω–æ
      button.disabled = false;
      
      // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –º–∞–≥–∞–∑–∏–Ω
      window.location.href = `${SITE_URL}/main.html`;
      
      return true;
      
    } else if (data.success && data.expired) {
      clearCheckInterval();
      button.disabled = false;
      showStatus('error', '‚ùå –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
      return false;
    }
    
    return false;
    
  } catch (checkError) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', checkError);
    return false;
  }
}

// –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
async function handleAuth(endpoint, button) {
  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
  clearCheckInterval();
  
  // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
  button.disabled = true;
  
  showStatus('loading');
  
  try {
    const response = await fetch(`${API_URL}/api/auth/${endpoint}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    const data = await response.json();
    
    if (data.success && data.telegramLink) {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω
      currentToken = data.token;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ Telegram
      showStatus('success');
      
      // –ñ–¥–µ–º 1 —Å–µ–∫—É–Ω–¥—É –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º Telegram
      setTimeout(() => {
        openTelegram(data.telegramLink);
      }, 1000);
      
      // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞
      checkInterval = setInterval(async () => {
        const success = await checkAuthStatus(currentToken, button);
        if (success) {
          clearCheckInterval();
        }
      }, 2000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
      
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è 3 –º–∏–Ω—É—Ç–∞–º–∏
      setTimeout(() => {
        if (checkInterval) {
          clearCheckInterval();
          button.disabled = false;
          showStatus('error', '‚ùå –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
        }
      }, 3 * 60 * 1000);
      
    } else {
      button.disabled = false;
      showStatus('error', `‚ùå ${data.error || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ Telegram'}`);
    }
  } catch (err) {
    button.disabled = false;
    showStatus('error', '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
    console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', err);
  }
}

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
registerBtn.addEventListener('click', () => {
  handleAuth('start-register', registerBtn);
});

// –í—Ö–æ–¥
loginBtn.addEventListener('click', () => {
  handleAuth('start-login', loginBtn);
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', () => {
  initLottieAnimation();
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω –≤ URL (–µ—Å–ª–∏ –≤–µ—Ä–Ω—É–ª–∏—Å—å –∏–∑ Telegram)
  const urlParams = new URLSearchParams(window.location.search);
  const authToken = urlParams.get('auth');
  
  if (authToken) {
    verifyAuthToken(authToken);
  }
});

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞ (–µ—Å–ª–∏ –ø—Ä–∏—à–ª–∏ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º auth)
async function verifyAuthToken(token) {
  try {
    showStatus('loading', '‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...');
    
    const response = await fetch(`${API_URL}/api/auth/check/${token}`);
    const data = await response.json();
    
    if (data.success && data.authenticated) {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –û–î–ò–ù–ê–ö–û–í–´–ú –∫–ª—é—á–æ–º
      localStorage.setItem(USER_KEY, JSON.stringify(data.user));
      console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω —á–µ—Ä–µ–∑ —Ç–æ–∫–µ–Ω:', data.user.username);
      
      // –£–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
      const newUrl = window.location.pathname;
      window.history.replaceState({}, '', newUrl);
      
      // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –º–∞–≥–∞–∑–∏–Ω
      window.location.href = `${SITE_URL}/main.html`;
    } else {
      showStatus('error', '‚ùå –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞:', error);
    showStatus('error', '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
  }
}

// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', () => {
  clearCheckInterval();
});
</script>
</body>
</html>
