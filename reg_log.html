<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(180deg, #0b3c91 0%, #1565c0 55%, #42a5f5 100%);
  display: flex;
  align-items: center;
  justify-content: center;
}

.auth-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 30px 20px;
  box-sizing: border-box;
  width: 100%;
  max-width: 400px;
}

.auth-sticker {
  width: 180px;
  height: 180px;
  margin-bottom: 30px;
}

@media (max-width: 480px) {
  .auth-sticker {
    width: 140px;
    height: 140px;
    margin-bottom: 25px;
  }
}

.auth-title {
  font-size: 28px;
  font-weight: 800;
  color: white;
  margin-bottom: 10px;
  text-align: center;
}

.auth-subtitle {
  font-size: 16px;
  color: rgba(255,255,255,0.8);
  margin-bottom: 30px;
  text-align: center;
  max-width: 320px;
  line-height: 1.4;
}

@media (max-width: 480px) {
  .auth-title {
    font-size: 24px;
  }
  
  .auth-subtitle {
    font-size: 14px;
    margin-bottom: 25px;
  }
}

.auth-buttons {
  display: flex;
  flex-direction: column;
  gap: 15px;
  width: 100%;
  max-width: 300px;
  margin-bottom: 30px;
}

.auth-btn {
  height: 56px;
  border-radius: 16px;
  border: none;
  font-weight: 700;
  font-size: 18px;
  cursor: pointer;
  transition: transform 0.15s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  text-decoration: none;
  color: inherit;
}

.auth-btn:active {
  transform: scale(.98);
}

.btn-login {
  background: white;
  color: #0b3c91;
}

.btn-register {
  background: rgba(255,255,255,0.1);
  color: white;
  border: 2px solid rgba(255,255,255,0.3);
}

.auth-link {
  margin-top: 20px;
  color: rgba(255,255,255,0.7);
  font-size: 14px;
  text-decoration: none;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: color 0.2s ease;
}

.auth-link:hover {
  color: white;
  text-decoration: underline;
}

.auth-link svg {
  width: 18px;
  height: 18px;
}

.status-message {
  margin-top: 15px;
  padding: 12px 16px;
  border-radius: 14px;
  font-size: 14px;
  font-weight: 700;
  text-align: center;
  display: none;
  width: 100%;
  max-width: 280px;
  box-sizing: border-box;
}

.status-loading {
  background: rgba(255,255,255,0.1);
  color: white;
  border-left: 4px solid #4fc3f7;
}

.status-success {
  background: rgba(0,200,83,0.15);
  color: white;
  border-left: 4px solid #00c853;
}

.status-error {
  background: rgba(255,45,85,0.15);
  color: white;
  border-left: 4px solid #ff2d55;
}

@media (max-width: 360px) {
  .auth-screen {
    padding: 20px 15px;
  }
  
  .auth-sticker {
    width: 120px;
    height: 120px;
    margin-bottom: 20px;
  }
  
  .auth-title {
    font-size: 22px;
  }
  
  .auth-subtitle {
    font-size: 13px;
    margin-bottom: 20px;
  }
  
  .auth-btn {
    height: 50px;
    font-size: 16px;
  }
  
  .auth-buttons {
    gap: 12px;
    max-width: 260px;
  }
}
</style>
</head>

<body>
<div class="auth-screen">
  <div id="lottie-animation" class="auth-sticker"></div>
  
  <div class="auth-title">–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</div>
  <div class="auth-subtitle">–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫–∞–∑–æ–≤ –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–æ—Ñ–∏–ª–µ–º</div>
  
  <div class="auth-buttons">
    <button class="auth-btn btn-login" id="loginBtn">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
      </svg>
      –í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç
    </button>
    
    <button class="auth-btn btn-register" id="registerBtn">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
      </svg>
      –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç
    </button>
  </div>
  
  <div class="status-message status-loading" id="loadingMessage">
    ‚è≥ –û—Ç–∫—Ä—ã–≤–∞–µ–º Telegram...
  </div>
  
  <div class="status-message status-success" id="successMessage">
    ‚è≥ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ Telegram –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...
  </div>
  
  <div class="status-message status-error" id="errorMessage"></div>
  
  <a href="https://destrkod.github.io/duckshop/main.html" class="auth-link">
    <svg viewBox="0 0 24 24" width="18" height="18">
      <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" fill="currentColor"/>
    </svg>
    –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω
  </a>
</div>

<script>
const API_URL = 'https://duck-shop-sever.onrender.com';
const SITE_URL = 'https://destrkod.github.io/duckshop';
const USER_KEY = 'duck_user_v1'; 

const registerBtn = document.getElementById('registerBtn');
const loginBtn = document.getElementById('loginBtn');
const loadingMessage = document.getElementById('loadingMessage');
const successMessage = document.getElementById('successMessage');
const errorMessage = document.getElementById('errorMessage');

let currentToken = null;
let checkInterval = null;

function initLottieAnimation() {
  try {
    lottie.loadAnimation({
      container: document.getElementById('lottie-animation'),
      renderer: 'svg',
      loop: true,
      autoplay: true,
      path: 'reg_log.json'
    });
  } catch (e) {
    console.log('Lottie –∞–Ω–∏–º–∞—Ü–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    document.getElementById('lottie-animation').innerHTML = 'üîê';
  }
}

function showStatus(type, message = '') {
  loadingMessage.style.display = 'none';
  successMessage.style.display = 'none';
  errorMessage.style.display = 'none';
  
  switch(type) {
    case 'loading':
      loadingMessage.style.display = 'block';
      break;
    case 'success':
      successMessage.style.display = 'block';
      break;
    case 'error':
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      break;
  }
}

function clearCheckInterval() {
  if (checkInterval) {
    clearInterval(checkInterval);
    checkInterval = null;
  }
}

function openTelegram(link) {
  const newWindow = window.open(link, '_blank');
  
  if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
    showStatus('error', '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å Telegram. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –≤—Ä—É—á–Ω—É—é.');
    
    const manualLink = document.createElement('a');
    manualLink.href = link;
    manualLink.target = '_blank';
    manualLink.textContent = '–ù–∞–∂–º–∏—Ç–µ –∑–¥–µ—Å—å —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å Telegram';
    manualLink.style.color = 'white';
    manualLink.style.textDecoration = 'underline';
    manualLink.style.marginTop = '10px';
    manualLink.style.display = 'block';
    
    errorMessage.appendChild(manualLink);
  }
}

async function checkAuthStatus(token, button) {
  try {
    const response = await fetch(`${API_URL}/api/auth/check/${token}`);
    const data = await response.json();
    
    if (data.success && data.authenticated) {
      clearCheckInterval();
      
      localStorage.setItem(USER_KEY, JSON.stringify(data.user));
      console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', data.user.username);
      
      button.disabled = false;
      
      window.location.href = `${SITE_URL}/main.html`;
      
      return true;
      
    } else if (data.success && data.expired) {
      clearCheckInterval();
      button.disabled = false;
      showStatus('error', '‚ùå –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
      return false;
    }
    
    return false;
    
  } catch (checkError) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', checkError);
    return false;
  }
}

async function handleAuth(endpoint, button) {
  clearCheckInterval();
  
  button.disabled = true;
  
  showStatus('loading');
  
  try {
    const response = await fetch(`${API_URL}/api/auth/${endpoint}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    const data = await response.json();
    
    if (data.success && data.telegramLink) {
      currentToken = data.token;
      
      showStatus('success');
      
      setTimeout(() => {
        openTelegram(data.telegramLink);
      }, 1000);
      
      checkInterval = setInterval(async () => {
        const success = await checkAuthStatus(currentToken, button);
        if (success) {
          clearCheckInterval();
        }
      }, 2000);
      
      setTimeout(() => {
        if (checkInterval) {
          clearCheckInterval();
          button.disabled = false;
          showStatus('error', '‚ùå –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
        }
      }, 3 * 60 * 1000);
      
    } else {
      button.disabled = false;
      showStatus('error', `‚ùå ${data.error || '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ Telegram'}`);
    }
  } catch (err) {
    button.disabled = false;
    showStatus('error', '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
    console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', err);
  }
}

registerBtn.addEventListener('click', () => {
  handleAuth('start-register', registerBtn);
});

loginBtn.addEventListener('click', () => {
  handleAuth('start-login', loginBtn);
});

document.addEventListener('DOMContentLoaded', () => {
  initLottieAnimation();
  
  const urlParams = new URLSearchParams(window.location.search);
  const authToken = urlParams.get('auth');
  
  if (authToken) {
    verifyAuthToken(authToken);
  }
});

async function verifyAuthToken(token) {
  try {
    showStatus('loading', '‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...');
    
    const response = await fetch(`${API_URL}/api/auth/check/${token}`);
    const data = await response.json();
    
    if (data.success && data.authenticated) {
      localStorage.setItem(USER_KEY, JSON.stringify(data.user));
      console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω —á–µ—Ä–µ–∑ —Ç–æ–∫–µ–Ω:', data.user.username);
      
      const newUrl = window.location.pathname;
      window.history.replaceState({}, '', newUrl);
      
      window.location.href = `${SITE_URL}/main.html`;
    } else {
      showStatus('error', '‚ùå –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞:', error);
    showStatus('error', '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
  }
}

window.addEventListener('beforeunload', () => {
  clearCheckInterval();
});
</script>
</body>
</html>
