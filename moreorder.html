<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ - Duck Shop</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

<style>
/* ===== –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò (–¢–û–ß–ù–û –ö–ê–ö –í –î–†–£–ì–ò–• –§–ê–ô–õ–ê–•) ===== */
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(180deg, #0b3c91 0%, #1565c0 55%, #42a5f5 100%);
  overflow-x: hidden;
}

/* ===== –•–ï–î–ï–† ===== */
.order-header {
  width: 100%;
  padding: 16px 20px;
  font-size: 22px;
  font-weight: 900;
  color: #fff;
  background: linear-gradient(180deg, #0b3c91, #124fa5);
  display: flex;
  align-items: center;
  gap: 15px;
  box-sizing: border-box;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  position: sticky;
  top: 0;
  z-index: 100;
}

/* –°–¢–†–ï–õ–ö–ê –ù–ê–ó–ê–î */
.back-arrow {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  background: rgba(255,255,255,.14);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.15s ease;
  color: white;
  font-size: 24px;
  font-weight: 900;
  text-decoration: none;
  flex-shrink: 0;
}

.back-arrow:hover {
  background: rgba(255,255,255,.20);
  transform: translateX(-2px);
}

.back-arrow:active {
  transform: scale(.95);
}

.order-title {
  font-size: 18px;
  font-weight: 800;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex: 1;
}

/* ===== –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ ===== */
.order-content {
  padding: 20px;
  box-sizing: border-box;
  overflow-y: auto;
  height: calc(100% - 72px);
}

/* ===== –°–ï–ö–¶–ò–ò –ó–ê–ö–ê–ó–ê ===== */
.order-section {
  background: rgba(255,255,255,0.1);
  border-radius: 20px;
  padding: 20px;
  margin-bottom: 20px;
}

.section-title {
  color: white;
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.section-title span:first-child {
  font-size: 20px;
}

.section-icon {
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.section-icon img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  filter: brightness(0) invert(1);
}

/* ===== –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ó–ê–ö–ê–ó–ï ===== */
.order-info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.info-item {
  background: rgba(255,255,255,0.08);
  border-radius: 14px;
  padding: 15px;
}

.info-label {
  color: rgba(255,255,255,0.7);
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 5px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.info-value {
  color: white;
  font-size: 16px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}

.order-id-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
}

.order-id-text {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.copy-btn {
  background: rgba(255,255,255,0.1);
  border: none;
  border-radius: 8px;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  flex-shrink: 0;
  margin-left: 8px;
}

.copy-btn:hover {
  background: rgba(255,255,255,0.2);
  transform: translateY(-1px);
}

.copy-btn:active {
  transform: scale(0.95);
}

.copy-btn.copied {
  background: rgba(76, 175, 80, 0.3);
}

.copy-icon {
  width: 16px;
  height: 16px;
  filter: brightness(0) invert(1);
}

/* –°–¢–ê–¢–£–°–´ */
.status-badge {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 800;
  text-transform: uppercase;
  margin-top: 5px;
}

.status-new {
  background: #4fc3f7;
  color: #003366;
}

.status-pending {
  background: #ffd700;
  color: #333;
}

.status-completed {
  background: #4CAF50;
  color: white;
}

.status-failed {
  background: #ff6b6b;
  color: white;
}

.status-canceled {
  background: #9e9e9e;
  color: white;
}

/* –ê–ö–¢–ò–í–ù–´–ô –ó–ê–ö–ê–ó - –í–´–î–ï–õ–ï–ù–ò–ï */
.active-order {
  border-left: 4px solid #4fc3f7;
  border-right: 4px solid #4fc3f7;
  position: relative;
}

.active-order::before {
  content: "üîÑ –ê–∫—Ç–∏–≤–Ω—ã–π";
  position: absolute;
  top: -10px;
  right: 20px;
  background: #4fc3f7;
  color: white;
  padding: 4px 10px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: 700;
  z-index: 1;
}

/* ===== –¢–û–í–ê–†–´ (–ö–ê–ö –í –ö–û–†–ó–ò–ù–ï) ===== */
.order-items {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.order-item-card {
  background: rgba(255,255,255,0.08);
  border-radius: 16px;
  padding: 15px;
  display: grid;
  grid-template-columns: 70px 1fr auto;
  gap: 15px;
  align-items: center;
  transition: transform 0.2s ease, background 0.2s ease;
}

.order-item-card:hover {
  background: rgba(255,255,255,0.12);
  transform: translateY(-2px);
}

.item-image {
  width: 70px;
  height: 70px;
  border-radius: 14px;
  background: linear-gradient(180deg, #1b3fd6 0%, #2f6bff 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  flex-shrink: 0;
}

.item-image img {
  max-width: 90%;
  max-height: 90%;
  object-fit: contain;
  display: block;
}

.item-info {
  min-width: 0;
}

.item-name {
  color: white;
  font-weight: 900;
  font-size: 15px;
  line-height: 1.2;
  margin-bottom: 5px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.item-sub {
  color: rgba(255,255,255,0.7);
  font-size: 13px;
  font-weight: 600;
}

.item-quantity {
  color: white;
  font-size: 16px;
  font-weight: 800;
  text-align: center;
  min-width: 40px;
}

/* ===== –ò–¢–û–ì–û ===== */
.order-total-section {
  background: rgba(255,255,255,0.1);
  border-radius: 20px;
  padding: 20px;
  margin-top: 20px;
}

.total-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.total-label {
  color: white;
  font-size: 16px;
  font-weight: 700;
}

.total-value {
  color: white;
  font-size: 20px;
  font-weight: 900;
}

.final-total {
  border-top: 2px solid rgba(255,255,255,0.2);
  padding-top: 15px;
  margin-top: 15px;
}

.final-total .total-label {
  font-size: 18px;
}

.final-total .total-value {
  font-size: 24px;
  color: #ffd700;
}

/* ===== –ö–ù–û–ü–ö–ê "–í–ï–†–ù–£–¢–¨–°–Ø –ö –û–§–û–†–ú–õ–ï–ù–ò–Æ" ===== */
.continue-button-container {
  margin-top: 25px;
  padding-top: 20px;
  border-top: 1px solid rgba(255,255,255,0.1);
}

.continue-button {
  width: 100%;
  padding: 18px 24px;
  font-size: 18px;
  font-weight: 800;
  background: linear-gradient(135deg, #4fc3f7, #2196f3);
  color: white;
  border: none;
  border-radius: 16px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  box-shadow: 0 8px 20px rgba(33, 150, 243, 0.3);
}

.continue-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 25px rgba(33, 150, 243, 0.4);
}

.continue-button:active {
  transform: translateY(0);
}

.continue-button:disabled {
  background: #cccccc;
  cursor: not-allowed;
  transform: none !important;
  box-shadow: none;
}

.button-icon {
  font-size: 20px;
}

/* ===== –ó–ê–ì–†–£–ó–ö–ê –ò –û–®–ò–ë–ö–ò ===== */
.loading-screen, .error-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  padding: 40px;
  text-align: center;
  box-sizing: border-box;
}

.loading-anim {
  width: 150px;
  height: 150px;
  margin-bottom: 20px;
}

.error-icon {
  font-size: 60px;
  margin-bottom: 20px;
}

.loading-text, .error-title {
  color: white;
  font-size: 22px;
  font-weight: 800;
  margin-bottom: 10px;
}

.error-text {
  color: rgba(255,255,255,0.8);
  font-size: 16px;
  margin-bottom: 30px;
  max-width: 400px;
}

/* ===== –ù–ï–¢ –ó–ê–ö–ê–ó–ê ===== */
.no-order {
  text-align: center;
  padding: 60px 20px;
}

.no-order-icon {
  font-size: 50px;
  margin-bottom: 20px;
  color: rgba(255,255,255,0.5);
}

.no-order-title {
  color: white;
  font-size: 20px;
  font-weight: 800;
  margin-bottom: 10px;
}

.no-order-text {
  color: rgba(255,255,255,0.7);
  font-size: 16px;
  margin-bottom: 30px;
}

/* ===== –ê–î–ê–ü–¢–ê–¶–ò–Ø ===== */
@media (max-width: 768px) {
  .order-header {
    padding: 14px 16px;
    font-size: 20px;
  }
  
  .back-arrow {
    width: 36px;
    height: 36px;
    font-size: 22px;
  }
  
  .order-content {
    padding: 16px;
  }
  
  .order-section {
    padding: 16px;
  }
  
  .order-info-grid {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  
  .order-item-card {
    grid-template-columns: 60px 1fr auto;
    gap: 12px;
    padding: 12px;
  }
  
  .item-image {
    width: 60px;
    height: 60px;
  }
  
  .item-name {
    font-size: 14px;
  }
  
  .item-quantity {
    font-size: 15px;
  }
  
  .continue-button {
    padding: 16px 20px;
    font-size: 16px;
  }
}

@media (max-width: 480px) {
  .order-header {
    padding: 12px 14px;
  }
  
  .order-title {
    font-size: 16px;
  }
  
  .back-arrow {
    width: 34px;
    height: 34px;
    font-size: 20px;
  }
  
  .section-title {
    font-size: 16px;
  }
  
  .info-value {
    font-size: 15px;
  }
  
  .final-total .total-label {
    font-size: 16px;
  }
  
  .final-total .total-value {
    font-size: 20px;
  }
  
  .continue-button {
    font-size: 15px;
  }
}

@media (max-width: 360px) {
  .order-content {
    padding: 12px;
  }
  
  .order-section {
    padding: 14px;
    border-radius: 16px;
  }
  
  .order-item-card {
    grid-template-columns: 50px 1fr auto;
    gap: 10px;
    padding: 10px;
  }
  
  .item-image {
    width: 50px;
    height: 50px;
  }
  
  .item-name {
    font-size: 13px;
  }
}
</style>
</head>

<body>

<!-- –•–ï–î–ï–† –°–¢–†–ï–õ–ö–û–ô -->
<div class="order-header">
  <a href="profile.html" class="back-arrow">‚Üê</a>
  <div class="order-title" id="orderTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<!-- –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò -->
<div id="loading" class="loading-screen" style="display: flex;">
  <div class="loading-anim" id="loadingAnim"></div>
  <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–∞...</div>
</div>

<!-- –≠–ö–†–ê–ù –û–®–ò–ë–ö–ò -->
<div id="error" class="error-screen" style="display: none;">
  <div class="error-icon">‚ö†Ô∏è</div>
  <div class="error-title" id="errorTitle">–û—à–∏–±–∫–∞</div>
  <div class="error-text" id="errorText"></div>
  <button class="back-arrow" onclick="window.location.href='profile.html'">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</button>
</div>

<!-- –ù–ï–¢ –ó–ê–ö–ê–ó–ê -->
<div id="noOrder" class="no-order" style="display: none;">
  <div class="no-order-icon">üì≠</div>
  <div class="no-order-title">–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω</div>
  <div class="no-order-text">–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã–π –∑–∞–∫–∞–∑ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –Ω–µ–º—É</div>
  <a href="profile.html" class="back-arrow" style="display: inline-flex; text-decoration: none; color: white;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª—å</a>
</div>

<!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ -->
<div id="content" class="order-content" style="display: none;">
  
  <!-- –û–°–ù–û–í–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø -->
  <div class="order-section" id="orderInfoSection">
    <div class="section-title">
      <div class="section-icon">
        <img src="https://cdn-icons-png.flaticon.com/512/69/69544.png" alt="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">
      </div>
      <span>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</span>
    </div>
    
    <div class="order-info-grid">
      <div class="info-item">
        <div class="info-label">
          <img src="https://upload.wikimedia.org/wikipedia/commons/9/91/Russian_number_sign.png" alt="ID" style="width: 14px; height: 14px; filter: brightness(0) invert(0.7);">
          –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
        </div>
        <div class="info-value">
          <div class="order-id-container">
            <span class="order-id-text" id="orderId">-</span>
            <button class="copy-btn" id="copyOrderIdBtn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞">
              <img src="https://i.pinimg.com/originals/ff/a4/84/ffa48433cacc0a64f19124cf1b53cbf0.png" alt="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å" class="copy-icon">
            </button>
          </div>
        </div>
      </div>
      
      <div class="info-item">
        <div class="info-label">
          <img src="https://cdn-icons-png.flaticon.com/512/747/747310.png" alt="–î–∞—Ç–∞" style="width: 14px; height: 14px; filter: brightness(0) invert(0.7);">
          –î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏
        </div>
        <div class="info-value" id="orderDate">-</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">
          <img src="https://cdn-icons-png.flaticon.com/512/88/88042.png" alt="Email" style="width: 14px; height: 14px; filter: brightness(0) invert(0.7);">
          Email
        </div>
        <div class="info-value" id="orderEmail">-</div>
      </div>
      
      <div class="info-item">
        <div class="info-label">
          <img src="https://images.icon-icons.com/3870/PNG/512/notification_status_icon_243707.png" alt="–°—Ç–∞—Ç—É—Å" style="width: 14px; height: 14px; filter: brightness(0) invert(0.7);">
          –°—Ç–∞—Ç—É—Å
        </div>
        <div class="info-value">
          <span id="orderStatusText">-</span>
          <div class="status-badge" id="orderStatusBadge"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- –°–û–°–¢–ê–í –ó–ê–ö–ê–ó–ê -->
  <div class="order-section">
    <div class="section-title">
      <div class="section-icon">
        <img src="https://cdn-icons-png.flaticon.com/512/6686/6686716.png" alt="–ö–æ—Ä–∑–∏–Ω–∞">
      </div>
      <span>–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞</span>
    </div>
    
    <div class="order-items" id="orderItems">
      <!-- –¢–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->
    </div>
  </div>
  
  <!-- –ò–¢–û–ì–û -->
  <div class="order-total-section">
    <div class="total-row">
      <div class="total-label">–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞</div>
      <div class="total-value" id="orderSubtotal">-</div>
    </div>
    
    <div class="total-row final-total">
      <div class="total-label">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ</div>
      <div class="total-value" id="orderTotal">-</div>
    </div>
  </div>
  
  <!-- –ö–ù–û–ü–ö–ê "–í–ï–†–ù–£–¢–¨–°–Ø –ö –û–§–û–†–ú–õ–ï–ù–ò–Æ" (–¢–û–õ–¨–ö–û –î–õ–Ø –ê–ö–¢–ò–í–ù–´–• –ó–ê–ö–ê–ó–û–í) -->
  <div class="continue-button-container" id="continueButtonContainer" style="display: none;">
    <button class="continue-button" id="continueOrderBtn">
      <span class="button-icon">‚Üª</span>
      <span id="continueButtonText">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é</span>
    </button>
  </div>
</div>

<script>
// ===== –ö–û–ù–°–¢–ê–ù–¢–´ =====
const API_URL = 'https://duck-shop-sever.onrender.com';
const USER_KEY = 'duck_user_v1';

// ===== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =====
let currentUser = null;
let currentOrder = null;
let allProducts = [];
let orderStage = '';

// ===== –£–¢–ò–õ–ò–¢–´ =====
function fmtRub(n) {
  if (!n) return '0 ‚ÇΩ';
  return `${n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ")} ‚ÇΩ`;
}

function formatDateTime(dateString) {
  if (!dateString) return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
  const date = new Date(dateString);
  return date.toLocaleDateString('ru-RU', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });
}

function getStatusText(status) {
  const statusMap = {
    'new': '–ù–æ–≤—ã–π',
    'pending': '–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã',
    'confirmed': '–û–ø–ª–∞—á–µ–Ω',
    'waiting': '–û–∂–∏–¥–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è',
    'completed': '–ó–∞–≤–µ—Ä—à–µ–Ω',
    'canceled': '–û—Ç–º–µ–Ω–µ–Ω',
    'failed': '–ù–µ—É–¥–∞—á–Ω—ã–π'
  };
  return statusMap[status] || status;
}

function getStatusClass(status) {
  const statusMap = {
    'new': 'status-new',
    'pending': 'status-pending',
    'confirmed': 'status-pending',
    'waiting': 'status-pending',
    'completed': 'status-completed',
    'canceled': 'status-canceled',
    'failed': 'status-failed'
  };
  return statusMap[status] || 'status-pending';
}

function isActiveOrder(status) {
  const activeStatuses = ['new', 'pending', 'confirmed', 'waiting_code_request', 'waiting'];
  return activeStatuses.includes(status);
}

// ===== –§–£–ù–ö–¶–ò–Ø –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø =====
function initCopyButton() {
  const copyBtn = document.getElementById('copyOrderIdBtn');
  const orderIdText = document.getElementById('orderId').textContent;
  
  copyBtn.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(orderIdText);
      
      // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
      const originalHTML = copyBtn.innerHTML;
      copyBtn.innerHTML = '<img src="https://i.imgur.com/6eB3VQz.png" alt="–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ" class="copy-icon">';
      copyBtn.classList.add('copied');
      
      setTimeout(() => {
        copyBtn.innerHTML = originalHTML;
        copyBtn.classList.remove('copied');
      }, 2000);
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
      // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
      const textArea = document.createElement('textarea');
      textArea.value = orderIdText;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      
      // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –¥–ª—è fallback
      copyBtn.classList.add('copied');
      setTimeout(() => {
        copyBtn.classList.remove('copied');
      }, 2000);
    }
  });
}

// ===== LOTTIE –ê–ù–ò–ú–ê–¶–ò–Ø =====
function initLottieAnimation() {
  try {
    lottie.loadAnimation({
      container: document.getElementById('loadingAnim'),
      renderer: 'svg',
      loop: true,
      autoplay: true,
      path: 'https://assets10.lottiefiles.com/packages/lf20_puciaevh.json'
    });
  } catch (error) {
    console.log('Lottie –∞–Ω–∏–º–∞—Ü–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    document.getElementById('loadingAnim').innerHTML = '‚è≥';
  }
}

// ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –≠–ö–†–ê–ù–ê–ú–ò =====
function showScreen(id) {
  const screens = ['loading', 'error', 'noOrder', 'content'];
  screens.forEach(screen => {
    document.getElementById(screen).style.display = 'none';
  });
  document.getElementById(id).style.display = id === 'content' ? 'block' : 'flex';
}

function showError(title, message) {
  document.getElementById('errorTitle').textContent = title;
  document.getElementById('errorText').textContent = message;
  showScreen('error');
}

// ===== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• =====
async function loadProducts() {
  try {
    const response = await fetch(`${API_URL}/api/products`);
    const data = await response.json();
    
    if (data.success && data.products) {
      allProducts = data.products;
      console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allProducts.length} —Ç–æ–≤–∞—Ä–æ–≤`);
    } else {
      console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã');
    }
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
  }
}

async function loadOrderData(orderId) {
  try {
    const response = await fetch(`${API_URL}/api/order-details/${orderId}`);
    const data = await response.json();
    
    if (data.success && data.order) {
      return data.order;
    }
    
    return null;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–∞:', error);
    return null;
  }
}

async function determineOrderStage(orderId) {
  try {
    const response = await fetch(`${API_URL}/api/order-stage/${orderId}`);
    const data = await response.json();
    
    if (data.success) {
      return {
        stage: data.stage,
        redirectUrl: data.redirectUrl
      };
    }
    return null;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —ç—Ç–∞–ø–∞ –∑–∞–∫–∞–∑–∞:', error);
    return null;
  }
}

function loadUser() {
  try {
    const userData = localStorage.getItem(USER_KEY);
    if (userData) {
      return JSON.parse(userData);
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
  }
  return null;
}

// ===== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –î–ê–ù–ù–´–• =====
function displayOrder(order) {
  // –ó–∞–≥–æ–ª–æ–≤–æ–∫
  document.getElementById('orderTitle').textContent = `–ó–∞–∫–∞–∑ #${order.id}`;
  document.getElementById('orderId').textContent = order.id;
  
  // –î–∞—Ç–∞
  document.getElementById('orderDate').textContent = formatDateTime(order.date);
  
  // Email
  document.getElementById('orderEmail').textContent = order.email || '–ù–µ —É–∫–∞–∑–∞–Ω';
  
  // –°—Ç–∞—Ç—É—Å
  const statusText = getStatusText(order.status);
  const statusClass = getStatusClass(order.status);
  document.getElementById('orderStatusText').textContent = statusText;
  const badge = document.getElementById('orderStatusBadge');
  badge.textContent = order.status;
  badge.className = `status-badge ${statusClass}`;
  
  // –í—ã–¥–µ–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–∫–∞–∑
  if (isActiveOrder(order.status)) {
    document.getElementById('orderInfoSection').classList.add('active-order');
  }
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
  initCopyButton();
  
  // –¢–æ–≤–∞—Ä—ã
  displayOrderItems(order.items || {});
  
  // –°—É–º–º—ã
  const subtotal = calculateSubtotal(order.items || {});
  const total = order.total || subtotal;
  
  document.getElementById('orderSubtotal').textContent = fmtRub(subtotal);
  document.getElementById('orderTotal').textContent = fmtRub(total);
  
  showScreen('content');
}

function calculateSubtotal(items) {
  let subtotal = 0;
  for (const [productId, quantity] of Object.entries(items)) {
    const product = allProducts.find(p => p.id === productId);
    if (product) {
      subtotal += product.price * quantity;
    }
  }
  return subtotal;
}

function displayOrderItems(items) {
  const container = document.getElementById('orderItems');
  container.innerHTML = '';
  
  if (!items || Object.keys(items).length === 0) {
    container.innerHTML = `
      <div style="color: rgba(255,255,255,0.6); text-align: center; padding: 30px;">
        –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–∞—Ö
      </div>
    `;
    return;
  }
  
  for (const [productId, quantity] of Object.entries(items)) {
    const product = allProducts.find(p => p.id === productId);
    
    const itemHtml = `
      <div class="order-item-card">
        <div class="item-image">
          <img src="${product ? product.image_url : 'https://i.imgur.com/s4K0WIP.png'}" 
               alt="${product ? product.name : '–¢–æ–≤–∞—Ä'}">
        </div>
        <div class="item-info">
          <div class="item-name">${product ? product.name : `–¢–æ–≤–∞—Ä ${productId}`}</div>
          <div class="item-sub">${fmtRub(product ? product.price : 0)} √ó ${quantity} —à—Ç.</div>
        </div>
        <div class="item-quantity">${quantity}</div>
      </div>
    `;
    
    container.innerHTML += itemHtml;
  }
}

// ===== –û–ë–†–ê–ë–û–¢–ö–ê –ö–ù–û–ü–ö–ò "–í–ï–†–ù–£–¢–¨–°–Ø –ö –û–§–û–†–ú–õ–ï–ù–ò–Æ" =====
async function setupContinueButton(orderId) {
  const continueContainer = document.getElementById('continueButtonContainer');
  const continueBtn = document.getElementById('continueOrderBtn');
  const continueText = document.getElementById('continueButtonText');
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —ç—Ç–∞–ø –∑–∞–∫–∞–∑–∞
  const stageData = await determineOrderStage(orderId);
  
  if (!stageData || !stageData.stage || stageData.stage === 'completed' || stageData.stage === 'unknown') {
    // –ó–∞–∫–∞–∑ –∑–∞–≤–µ—Ä—à–µ–Ω –∏–ª–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω - —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
    continueContainer.style.display = 'none';
    return;
  }
  
  // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —ç—Ç–∞–ø–∞
  let buttonText = '–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é';
  
  switch(stageData.stage) {
    case 'email_required':
      buttonText = '–í–≤–µ—Å—Ç–∏ email ‚Üí';
      break;
    case 'waiting_code_request':
      buttonText = '–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –∫–æ–¥–∞ ‚Üí';
      break;
    case 'code_required':
      buttonText = '–í–≤–µ—Å—Ç–∏ –∫–æ–¥ ‚Üí';
      break;
    case 'waiting_execution':
      buttonText = '–û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è ‚Üí';
      break;
    case 'support_needed':
      buttonText = '–°–≤—è–∑—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π ‚Üí';
      break;
  }
  
  continueText.textContent = buttonText;
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
  continueContainer.style.display = 'block';
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è
  continueBtn.onclick = function() {
    window.location.href = stageData.redirectUrl;
  };
}

// ===== –û–°–ù–û–í–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
async function init() {
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  currentUser = loadUser();
  
  if (!currentUser) {
    showError('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞', '–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã');
    return;
  }
  
  // –ü–æ–ª—É—á–∞–µ–º ID –∑–∞–∫–∞–∑–∞ –∏–∑ URL
  const urlParams = new URLSearchParams(window.location.search);
  const orderId = urlParams.get('order');
  
  if (!orderId) {
    showScreen('noOrder');
    return;
  }
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã
  await loadProducts();
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞
  currentOrder = await loadOrderData(orderId);
  
  if (!currentOrder) {
    showScreen('noOrder');
    return;
  }
  
  // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞–∫–∞–∑
  displayOrder(currentOrder);
  
  // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é" (–µ—Å–ª–∏ –∑–∞–∫–∞–∑ –∞–∫—Ç–∏–≤–Ω—ã–π)
  if (isActiveOrder(currentOrder.status)) {
    await setupContinueButton(orderId);
  }
}

// ===== –û–ë–†–ê–ë–û–¢–ß–ò–ö –ó–ê–ì–†–£–ó–ö–ò =====
document.addEventListener('DOMContentLoaded', () => {
  initLottieAnimation();
  
  // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
  setTimeout(() => {
    init();
  }, 500);
});
</script>
</body>
</html>
